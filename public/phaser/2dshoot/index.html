<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.16.2/dist/phaser.min.js"></script>
</head>

<body>
    <script>
        
        var config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            physics: {
                default: "arcade",
                arcade: {
                    gravity: {
                        y: 570
                    },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        var bullets;
        var reticle;
        var game = new Phaser.Game(config);
        var score = 0;
        var scoreText;

        function preload() {
            this.load.image("sky", "assets/sky.png");
            this.load.image("ground", "assets/platform.png");
            this.load.image("star", "assets/star.png");
            this.load.image("bomb", "assets/bomb.png");
            this.load.image("bullet","assets/bomb.png")
            this.load.image("target","assets/ball.png")
            this.load.spritesheet("dude", "assets/dude.png", {
                frameWidth: 32,
                frameHeight: 48
            });
        }

        var platforms;
        var enemytest=new Phaser.Class({
            
        });
        var Bullet = new Phaser.Class({

Extends: Phaser.GameObjects.Image,

initialize:

// Bullet Constructor
function Bullet (scene)
{
    Phaser.GameObjects.Image.call(this, scene, 0, 0, 'bullet');
    this.speed = 1;
    this.born = 0;
    this.direction = 0;
    this.xSpeed = 0;
    this.ySpeed = 0;
    this.setSize(12, 12, true);
},

// Fires a bullet from the player to the reticle
fire: function (shooter, target)
{
    this.body.setAllowGravity(false);
    this.setPosition(shooter.x, shooter.y); // Initial position
    this.direction = Math.atan( (target.x-this.x) / (target.y-this.y));
    // Calculate X and y velocity of bullet to moves it from shooter to target
    if (target.y >= this.y)
    {
        this.xSpeed = this.speed*Math.sin(this.direction);
        this.ySpeed = this.speed*Math.cos(this.direction);
    }
    else
    {
        this.xSpeed = -this.speed*Math.sin(this.direction);
        this.ySpeed = -this.speed*Math.cos(this.direction);
    }

    this.rotation = shooter.rotation; // angle bullet with shooters rotation
    this.born = 0; // Time since new bullet spawned
},

// Updates the position of the bullet each cycle
update: function (time, delta)
{
    this.x += this.xSpeed * delta;
    this.y += this.ySpeed * delta;
    this.born += delta;
    if (this.born > 1800)
    {
        this.setActive(false);
        this.setVisible(false);
    }
}

});


        function create() {
            this.add.image(400, 300, "sky");
            reticle = this.physics.add.sprite(800, 700, 'target');
            reticle.body.setAllowGravity(false);
            reticle.setDepth(1);
            reticle.setOrigin(0.5, 0.5).setDisplaySize(25, 25).setCollideWorldBounds(true);
            platforms = this.physics.add.staticGroup();

            bullets = this.physics.add.group({
                classType: Bullet,
                maxSize: 40,
                runChildUpdate: true
            });

            game.canvas.addEventListener('mousedown', function () {
        game.input.mouse.requestPointerLock();
    });

    // Exit pointer lock when Q or escape (by default) is pressed.
    this.input.keyboard.on('keydown_E', function (event) {
        if (game.input.mouse.locked)
            game.input.mouse.releasePointerLock();
    }, 0, this);

    // Move reticle upon locked pointer move
    this.input.on('pointermove', function (pointer) {
        if (this.input.mouse.locked)
        {
            reticle.x += pointer.movementX;
            reticle.y += pointer.movementY;
        }
    }, this);

    this.input.on('pointerdown', function (pointer, time, lastFired) {
        if (player.active === false)
            return;

        // Get bullet from bullets group
        var bullet = bullets.get().setActive(true).setVisible(true);

        if (bullet)
        {
            bullet.fire(player, reticle);
            //this.physics.add.collider(enemy, bullet, enemyHitCallback);
        }
    }, this);
            
            platforms
                .create(400, 568, "ground")
                .setScale(2)
                .refreshBody();

            platforms.create(660, 400, "ground");
            platforms.create(50, 250, "ground");
            platforms.create(750, 220, "ground");
            player = this.physics.add.sprite(100, 450, "dude");

            player.setBounce(0.1);
            //CHANGE AFTER TO 0.2
            player.setCollideWorldBounds(true);

            this.anims.create({
                key: "left",
                frames: this.anims.generateFrameNumbers("dude", {
                    start: 0,
                    end: 3
                }),
                frameRate: 10,
                repeat: -1
            });

            this.anims.create({
                key: "turn",
                frames: [{
                    key: "dude",
                    frame: 4
                }],
                frameRate: 20
            });

            this.anims.create({
                key: "right",
                frames: this.anims.generateFrameNumbers("dude", {
                    start: 5,
                    end: 8
                }),
                frameRate: 10,
                repeat: -1
            });

            cursors = this.input.keyboard.createCursorKeys();
            stars = this.physics.add.group({
                key: "star",
                repeat: 11,
                setXY: {
                    x: 12,
                    y: 0,
                    stepX: 70
                }
            });

            stars.children.iterate(function (child) {
                child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
            });
            scoreText = this.add.text(16, 16, "score: 0", {
                fontSize: "32px",
                fill: "#000"
            });
            bombs = this.physics.add.group();

            this.physics.add.collider(bombs, platforms);
            this.physics.add.collider(bombs, bombs);
            this.physics.add.collider(player, bombs, hitBomb, null, this);

            this.physics.add.collider(player, platforms);
            this.physics.add.collider(platforms, reticle);

            this.physics.add.collider(stars, platforms);
            this.physics.add.overlap(player, stars, collectStar, null, this);
            this.physics.add.overlap(platforms, bullets, projectilecancel, null, this);
            this.physics.add.collider(bullets,platforms);
        }

        function update() {
            //player.setAccelerationX(player.body.accelerationX*0.7);
            //player.setVelocityX(player.body.velocityX*0.7);
            if (cursors.left.isDown) {
                player.setVelocityX(-270);
               
                player.anims.play("left", true);
            } else if (cursors.right.isDown) {
                player.setVelocityX(270);
                //player.setAccelerationX(-100);
                player.anims.play("right", true);
            } else {
                player.setVelocityX(0);
//                player.setVelocityX(player.body.velocityX*0.7);

                player.anims.play("turn");
            }

            if (cursors.up.isDown && player.body.touching.down) {
                player.setVelocityY(-440);
            }
        }
        function projectilecancel(platform,bullet){
            bullet.setActive(false);
            bullet.setVisible(false);

        }
        function collectStar(player, star) {
            star.disableBody(true, true);

            score += 10;
            scoreText.setText("Score: " + score);

            if (stars.countActive(true) === 0) {
                stars.children.iterate(function (child) {
                    child.enableBody(true, child.x, 0, true, true);
                });

                var x =
                    player.x < 400 ?
                    Phaser.Math.Between(400, 800) :
                    Phaser.Math.Between(0, 400);
                for (i = 0; i < Phaser.Math.Between(1, 6); i++) {
                    var bomb = bombs.create(x, 16, "bomb");
                    bomb.setBounce(Phaser.Math.Between(1, 1.001));
                    bomb.setCollideWorldBounds(true);
                    bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
                }
            }
        }

        function hitBomb(player, bomb) {
            //this.physics.pause();

            player.setTint(0xff0000);

            player.anims.play("turn");

            //gameOver = true;
        }
    </script>
</body>

</html>